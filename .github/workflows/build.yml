name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  MACOS_VERSION: '14'

jobs:
  build:
    name: Build Wawona
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config pixman wayland || true
          
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          
      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
          
      - name: Run tests
        run: |
          cd build
          if [ -f tests/test_wayland_client ]; then
            ./tests/test_wayland_client || true
          fi
          
      - name: Check binary exists
        run: |
          if [ ! -f build/Wawona ]; then
            echo "❌ Binary not found!"
            exit 1
          fi
          echo "✅ Build successful!"
          ls -lh build/Wawona

  lint:
    name: Lint Code
    runs-on: macos-${{ env.MACOS_VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install clang-format and clang-tidy
        run: |
          brew install clang-format llvm || true
          
      - name: Check formatting
        run: |
          find src -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror || exit 1
          find src -name "*.m" -o -name "*.h" | xargs clang-format --dry-run --Werror || exit 1
          
      - name: Run clang-tidy
        run: |
          if command -v clang-tidy >/dev/null 2>&1; then
            find src -name "*.c" -o -name "*.h" | head -5 | xargs clang-tidy -p build/ || true
          else
            echo "⚠️ clang-tidy not available, skipping"
          fi

  protocol-check:
    name: Verify Protocols
    runs-on: macos-${{ env.MACOS_VERSION }}
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install dependencies
        run: |
          brew update
          brew install cmake pkg-config pixman wayland || true
          
      - name: Build test client
        run: |
          cd tests
          make -f Makefile.test_client macos_wlclient_test || true
          
      - name: Check protocol implementations
        run: |
          echo "Checking for protocol implementations..."
          PROTOCOLS=(
            "wl_compositor"
            "wl_output"
            "wl_seat"
            "wl_shm"
            "wl_subcompositor"
            "wl_data_device_manager"
            "xdg_wm_base"
            "zwp_linux_dmabuf_v1"
            "zwp_screencopy_manager_v1"
          )
          for proto in "${PROTOCOLS[@]}"; do
            if grep -r "wl_global_create.*$proto" src/ >/dev/null 2>&1; then
              echo "✅ $proto found"
            else
              echo "❌ $proto NOT FOUND"
              exit 1
            fi
          done

