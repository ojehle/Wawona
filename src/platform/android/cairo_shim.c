#include "cairo_shim.h"
#include <pixman.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* Minimal 8x16 font for terminal rendering */
static const uint8_t font8x16[128][16] = {
    [0x20] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00}, // space
    ['!'] = {0x18, 0x3c, 0x3c, 0x3c, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['"'] = {0x6c, 0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['#'] = {0x36, 0x36, 0x7f, 0x36, 0x36, 0x36, 0x7f, 0x36, 0x36, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['$'] = {0x18, 0x3e, 0x60, 0x3c, 0x06, 0x7c, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['%'] = {0x00, 0x63, 0x66, 0x0c, 0x18, 0x33, 0x63, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['&'] = {0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['\''] = {0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00},
    ['('] = {0x0c, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    [')'] = {0x30, 0x18, 0x0c, 0x0c, 0x0c, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['*'] = {0x00, 0x18, 0xdb, 0x3c, 0xdb, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['+'] = {0x00, 0x18, 0x18, 0x7e, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['-'] = {0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['/'] = {0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['0'] = {0x3c, 0x66, 0x6e, 0x76, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['1'] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['2'] = {0x3c, 0x66, 0x06, 0x0c, 0x18, 0x30, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['3'] = {0x3c, 0x66, 0x06, 0x1c, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['4'] = {0x0c, 0x1c, 0x3c, 0x6c, 0x7e, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['5'] = {0x7e, 0x60, 0x7c, 0x06, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['6'] = {0x1c, 0x30, 0x60, 0x7c, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['7'] = {0x7e, 0x06, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['8'] = {0x3c, 0x66, 0x66, 0x3c, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['9'] = {0x3c, 0x66, 0x66, 0x3e, 0x06, 0x0c, 0x38, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    [':'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    [';'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['<'] = {0x0c, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['='] = {0x00, 0x00, 0x7e, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['>'] = {0x30, 0x18, 0x0c, 0x06, 0x0c, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['?'] = {0x3c, 0x66, 0x06, 0x0c, 0x18, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['@'] = {0x3c, 0x66, 0x06, 0x3e, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['A'] = {0x18, 0x3c, 0x66, 0x66, 0x7e, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['B'] = {0x7c, 0x66, 0x66, 0x7c, 0x66, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['C'] = {0x3c, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['D'] = {0x78, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0x78, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['E'] = {0x7e, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['F'] = {0x7e, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['G'] = {0x3c, 0x66, 0x60, 0x6e, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['H'] = {0x66, 0x66, 0x66, 0x7e, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['I'] = {0x3c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['J'] = {0x1e, 0x0c, 0x0c, 0x0c, 0x0c, 0xcc, 0x78, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['K'] = {0x66, 0x6c, 0x78, 0x70, 0x78, 0x6c, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['L'] = {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['M'] = {0x63, 0x77, 0x7f, 0x6b, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['N'] = {0x66, 0x66, 0x76, 0x7e, 0x7e, 0x6e, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['O'] = {0x3c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['P'] = {0x7c, 0x66, 0x66, 0x7c, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['Q'] = {0x3c, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x0e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['R'] = {0x7c, 0x66, 0x66, 0x7c, 0x78, 0x6c, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['S'] = {0x3c, 0x66, 0x30, 0x18, 0x0c, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['T'] = {0x7e, 0x5a, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['U'] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['V'] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['W'] = {0x63, 0x63, 0x63, 0x6b, 0x7f, 0x77, 0x63, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['X'] = {0x66, 0x66, 0x3c, 0x18, 0x3c, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['Y'] = {0x66, 0x66, 0x66, 0x3c, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['Z'] = {0x7e, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['['] = {0x3c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['\\'] = {0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00},
    [']'] = {0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['^'] = {0x18, 0x3c, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['`'] = {0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['a'] = {0x00, 0x00, 0x3c, 0x06, 0x3e, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['b'] = {0x60, 0x60, 0x7c, 0x66, 0x66, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['c'] = {0x00, 0x00, 0x3c, 0x60, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['d'] = {0x06, 0x06, 0x3e, 0x66, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['e'] = {0x00, 0x00, 0x3c, 0x66, 0x7e, 0x60, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['f'] = {0x1c, 0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['g'] = {0x00, 0x00, 0x3e, 0x66, 0x66, 0x3e, 0x06, 0x3c, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['h'] = {0x60, 0x60, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['i'] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['j'] = {0x06, 0x00, 0x0e, 0x06, 0x06, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['k'] = {0x60, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['l'] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['m'] = {0x00, 0x00, 0x66, 0x7f, 0x7f, 0x6b, 0x63, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['n'] = {0x00, 0x00, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['o'] = {0x00, 0x00, 0x3c, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['p'] = {0x00, 0x00, 0x7c, 0x66, 0x66, 0x7c, 0x60, 0x60, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['q'] = {0x00, 0x00, 0x3e, 0x66, 0x66, 0x3e, 0x06, 0x06, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['r'] = {0x00, 0x00, 0x7c, 0x66, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['s'] = {0x00, 0x00, 0x3e, 0x60, 0x3c, 0x06, 0x7c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['t'] = {0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x1c, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['u'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['v'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['w'] = {0x00, 0x00, 0x63, 0x6b, 0x7f, 0x77, 0x63, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['x'] = {0x00, 0x00, 0x66, 0x3c, 0x18, 0x3c, 0x66, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['y'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3e, 0x06, 0x3c, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['z'] = {0x00, 0x00, 0x7e, 0x0c, 0x18, 0x30, 0x7e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['{'] = {0x0e, 0x18, 0x18, 0x30, 0x18, 0x18, 0x0e, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['|'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['}'] = {0x70, 0x18, 0x18, 0x0c, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
    ['~'] = {0x3b, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
             0x00, 0x00, 0x00, 0x00, 0x00},
};

struct _cairo_surface {
  pixman_image_t *pixman_image;
  cairo_format_t format;
  int width, height;
  unsigned char *data;
  int stride;
  int ref_count;
};

struct _cairo {
  cairo_surface_t *target;
  pixman_color_t source_color;
  double line_width;
  cairo_matrix_t matrix;
  cairo_operator_t op;
  /* Basic path */
  double curr_x, curr_y;
  double rect_x, rect_y, rect_w, rect_h;
  int has_rect;
};

struct _PangoLayout {
  cairo_t *cr;
  char *text;
};

struct _PangoFontDescription {
  char *family;
  int size;
};

/* Internal mapping */
static pixman_format_code_t cairo_to_pixman_format(cairo_format_t format) {
  switch (format) {
  case CAIRO_FORMAT_ARGB32:
    return PIXMAN_a8r8g8b8;
  case CAIRO_FORMAT_RGB24:
    return PIXMAN_x8r8g8b8;
  case CAIRO_FORMAT_A8:
    return PIXMAN_a8;
  default:
    return PIXMAN_a8r8g8b8;
  }
}

/* Surface Implementation */
cairo_surface_t *cairo_image_surface_create(cairo_format_t format, int width,
                                            int height) {
  cairo_surface_t *surf = calloc(1, sizeof(cairo_surface_t));
  surf->format = format;
  surf->width = width;
  surf->height = height;
  surf->ref_count = 1;
  surf->pixman_image = pixman_image_create_bits(cairo_to_pixman_format(format),
                                                width, height, NULL, 0);
  surf->data = (unsigned char *)pixman_image_get_data(surf->pixman_image);
  surf->stride = pixman_image_get_stride(surf->pixman_image);
  return surf;
}

cairo_surface_t *cairo_image_surface_create_for_data(unsigned char *data,
                                                     cairo_format_t format,
                                                     int width, int height,
                                                     int stride) {
  cairo_surface_t *surf = calloc(1, sizeof(cairo_surface_t));
  surf->format = format;
  surf->width = width;
  surf->height = height;
  surf->data = data;
  surf->stride = stride;
  surf->ref_count = 1;
  surf->pixman_image = pixman_image_create_bits(
      cairo_to_pixman_format(format), width, height, (uint32_t *)data, stride);
  return surf;
}

void cairo_surface_destroy(cairo_surface_t *surface) {
  if (!surface)
    return;
  if (--surface->ref_count == 0) {
    pixman_image_unref(surface->pixman_image);
    free(surface);
  }
}

void cairo_surface_reference(cairo_surface_t *surface) {
  if (surface)
    surface->ref_count++;
}

cairo_status_t cairo_surface_status(cairo_surface_t *surface) {
  return CAIRO_STATUS_SUCCESS;
}
void cairo_surface_flush(cairo_surface_t *surface) {}
void cairo_surface_mark_dirty(cairo_surface_t *surface) {}
unsigned char *cairo_image_surface_get_data(cairo_surface_t *surface) {
  return surface ? surface->data : NULL;
}
int cairo_image_surface_get_stride(cairo_surface_t *surface) {
  return surface ? surface->stride : 0;
}
int cairo_image_surface_get_width(cairo_surface_t *surface) {
  return surface ? surface->width : 0;
}
int cairo_image_surface_get_height(cairo_surface_t *surface) {
  return surface ? surface->height : 0;
}
cairo_format_t cairo_image_surface_get_format(cairo_surface_t *surface) {
  return surface ? surface->format : CAIRO_FORMAT_INVALID;
}
cairo_device_t *cairo_surface_get_device(cairo_surface_t *surface) {
  return NULL;
}
cairo_content_t cairo_surface_get_content(cairo_surface_t *surface) {
  return CAIRO_CONTENT_COLOR_ALPHA;
}

/* Context Implementation */
cairo_t *cairo_create(cairo_surface_t *target) {
  cairo_t *cr = calloc(1, sizeof(cairo_t));
  cr->target = target;
  cairo_surface_reference(target);
  cr->matrix.xx = 1.0;
  cr->matrix.yy = 1.0;
  cr->line_width = 1.0;
  cr->source_color.alpha = 0xffff;
  return cr;
}

void cairo_destroy(cairo_t *cr) {
  if (!cr)
    return;
  cairo_surface_destroy(cr->target);
  free(cr);
}

cairo_status_t cairo_status(cairo_t *cr) { return CAIRO_STATUS_SUCCESS; }
void cairo_save(cairo_t *cr) {}
void cairo_restore(cairo_t *cr) {}

/* Drawing Implementation */
void cairo_set_source_rgb(cairo_t *cr, double red, double green, double blue) {
  cairo_set_source_rgba(cr, red, green, blue, 1.0);
}

void cairo_set_source_rgba(cairo_t *cr, double red, double green, double blue,
                           double alpha) {
  cr->source_color.red = (uint16_t)(red * 65535.0);
  cr->source_color.green = (uint16_t)(green * 65535.0);
  cr->source_color.blue = (uint16_t)(blue * 65535.0);
  cr->source_color.alpha = (uint16_t)(alpha * 65535.0);
}

void cairo_set_source_surface(cairo_t *cr, cairo_surface_t *surface, double x,
                              double y) {
  /* TODO: implement pattern from surface if needed for terminal icons */
}

void cairo_set_operator(cairo_t *cr, cairo_operator_t op) { cr->op = op; }
void cairo_set_line_width(cairo_t *cr, double width) { cr->line_width = width; }

void cairo_rectangle(cairo_t *cr, double x, double y, double width,
                     double height) {
  cr->rect_x = x;
  cr->rect_y = y;
  cr->rect_w = width;
  cr->rect_h = height;
  cr->has_rect = 1;
}

void cairo_fill(cairo_t *cr) {
  if (cr->has_rect) {
    pixman_box32_t box = {(int32_t)cr->rect_x, (int32_t)cr->rect_y,
                          (int32_t)(cr->rect_x + cr->rect_w),
                          (int32_t)(cr->rect_y + cr->rect_h)};
    pixman_image_fill_boxes(PIXMAN_OP_SRC, cr->target->pixman_image,
                            &cr->source_color, 1, &box);
    cr->has_rect = 0;
  }
}

void cairo_fill_preserve(cairo_t *cr) {
  int old_has = cr->has_rect;
  cairo_fill(cr);
  cr->has_rect = old_has;
}

void cairo_stroke(cairo_t *cr) {
  /* Minimal stroke: just fill the rectangle outline if it exists */
  if (cr->has_rect) {
    pixman_box32_t boxes[4];
    int lw = (int)cr->line_width;
    if (lw < 1)
      lw = 1;

    // Top
    boxes[0].x1 = (int32_t)cr->rect_x;
    boxes[0].y1 = (int32_t)cr->rect_y;
    boxes[0].x2 = (int32_t)(cr->rect_x + cr->rect_w);
    boxes[0].y2 = (int32_t)(cr->rect_y + lw);
    // Bottom
    boxes[1].x1 = (int32_t)cr->rect_x;
    boxes[1].y1 = (int32_t)(cr->rect_y + cr->rect_h - lw);
    boxes[1].x2 = (int32_t)(cr->rect_x + cr->rect_w);
    boxes[1].y2 = (int32_t)(cr->rect_y + cr->rect_h);
    // Left
    boxes[2].x1 = (int32_t)cr->rect_x;
    boxes[2].y1 = (int32_t)cr->rect_y;
    boxes[2].x2 = (int32_t)(cr->rect_x + lw);
    boxes[2].y2 = (int32_t)(cr->rect_y + cr->rect_h);
    // Right
    boxes[3].x1 = (int32_t)(cr->rect_x + cr->rect_w - lw);
    boxes[3].y1 = (int32_t)cr->rect_y;
    boxes[3].x2 = (int32_t)(cr->rect_x + cr->rect_w);
    boxes[3].y2 = (int32_t)(cr->rect_y + cr->rect_h);

    pixman_image_fill_boxes(PIXMAN_OP_SRC, cr->target->pixman_image,
                            &cr->source_color, 4, boxes);
    cr->has_rect = 0;
  }
}

void cairo_stroke_preserve(cairo_t *cr) {
  int old_has = cr->has_rect;
  cairo_stroke(cr);
  cr->has_rect = old_has;
}

void cairo_paint(cairo_t *cr) {
  pixman_box32_t box = {0, 0, cr->target->width, cr->target->height};
  pixman_image_fill_boxes(PIXMAN_OP_SRC, cr->target->pixman_image,
                          &cr->source_color, 1, &box);
}

void cairo_clip(cairo_t *cr) {}
void cairo_reset_clip(cairo_t *cr) {}

/* Path Implementation */
void cairo_move_to(cairo_t *cr, double x, double y) {
  cr->curr_x = x;
  cr->curr_y = y;
}
void cairo_line_to(cairo_t *cr, double x, double y) {
  cr->curr_x = x;
  cr->curr_y = y;
}
void cairo_rel_line_to(cairo_t *cr, double dx, double dy) {
  cr->curr_x += dx;
  cr->curr_y += dy;
}
void cairo_close_path(cairo_t *cr) {}
void cairo_new_path(cairo_t *cr) { cr->has_rect = 0; }
void cairo_new_sub_path(cairo_t *cr) {}

/* Transformation Implementation */
void cairo_translate(cairo_t *cr, double tx, double ty) {
  cr->matrix.x0 += tx;
  cr->matrix.y0 += ty;
}
void cairo_scale(cairo_t *cr, double sx, double sy) {
  cr->matrix.xx *= sx;
  cr->matrix.yy *= sy;
}
void cairo_rotate(cairo_t *cr, double angle) {}
void cairo_transform(cairo_t *cr, const cairo_matrix_t *matrix) {}
void cairo_set_matrix(cairo_t *cr, const cairo_matrix_t *matrix) {
  cr->matrix = *matrix;
}
void cairo_get_matrix(cairo_t *cr, cairo_matrix_t *matrix) {
  *matrix = cr->matrix;
}
void cairo_identity_matrix(cairo_t *cr) {
  memset(&cr->matrix, 0, sizeof(cairo_matrix_t));
  cr->matrix.xx = 1.0;
  cr->matrix.yy = 1.0;
}

/* Text Implementation */
static void draw_char(cairo_t *cr, int x, int y, uint8_t ch) {
  if (ch >= 128)
    ch = '?';
  const uint8_t *bits = font8x16[ch];
  pixman_image_t *src = pixman_image_create_solid_fill(&cr->source_color);

  for (int i = 0; i < 16; i++) {
    uint8_t row = bits[i];
    for (int j = 0; j < 8; j++) {
      if (row & (0x80 >> j)) {
        pixman_box32_t pixel = {(int32_t)(x + j), (int32_t)(y + i),
                                (int32_t)(x + j + 1), (int32_t)(y + i + 1)};
        pixman_image_fill_boxes(PIXMAN_OP_OVER, cr->target->pixman_image,
                                &cr->source_color, 1, &pixel);
      }
    }
  }
  pixman_image_unref(src);
}

void cairo_select_font_face(cairo_t *cr, const char *family,
                            cairo_font_slant_t slant,
                            cairo_font_weight_t weight) {}
void cairo_set_font_size(cairo_t *cr, double size) {}
void cairo_show_text(cairo_t *cr, const char *utf8) {
  int x = (int)cr->curr_x;
  int y = (int)cr->curr_y;
  while (*utf8) {
    draw_char(cr, x, y - 12, *utf8); // Adjust baseline roughly
    x += 8;
    utf8++;
  }
  cr->curr_x = x;
}

void cairo_show_glyphs(cairo_t *cr, const cairo_glyph_t *glyphs,
                       int num_glyphs) {
  for (int i = 0; i < num_glyphs; i++) {
    draw_char(cr, (int)glyphs[i].x, (int)glyphs[i].y - 12,
              (uint8_t)glyphs[i].index);
  }
}

void cairo_font_extents(cairo_t *cr, cairo_font_extents_t *extents) {
  extents->ascent = 12;
  extents->descent = 4;
  extents->height = 16;
  extents->max_x_advance = 8;
  extents->max_y_advance = 0;
}

void cairo_text_extents(cairo_t *cr, const char *utf8,
                        cairo_text_extents_t *extents) {
  int len = strlen(utf8);
  extents->x_bearing = 0;
  extents->y_bearing = -12;
  extents->width = len * 8;
  extents->height = 16;
  extents->x_advance = len * 8;
  extents->y_advance = 0;
}

/* Pango Implementation */
PangoLayout *pango_cairo_create_layout(cairo_t *cr) {
  PangoLayout *layout = calloc(1, sizeof(PangoLayout));
  layout->cr = cr;
  return layout;
}

void pango_layout_set_text(PangoLayout *layout, const char *text, int length) {
  if (layout->text)
    free(layout->text);
  if (length < 0)
    length = strlen(text);
  layout->text = malloc(length + 1);
  memcpy(layout->text, text, length);
  layout->text[length] = '\0';
}

void pango_layout_get_pixel_size(PangoLayout *layout, int *width, int *height) {
  if (width)
    *width = (layout->text ? strlen(layout->text) : 0) * 8;
  if (height)
    *height = 16;
}

void pango_cairo_show_layout(cairo_t *cr, PangoLayout *layout) {
  if (layout->text) {
    cairo_show_text(cr, layout->text);
  }
}

void pango_layout_set_font_description(PangoLayout *layout,
                                       const PangoFontDescription *desc) {}
void g_object_unref(void *object) { free(object); }

PangoFontDescription *pango_font_description_new(void) {
  return calloc(1, sizeof(PangoFontDescription));
}
PangoFontDescription *pango_font_description_from_string(const char *str) {
  return pango_font_description_new();
}
void pango_font_description_set_family(PangoFontDescription *desc,
                                       const char *family) {}
void pango_font_description_set_size(PangoFontDescription *desc, int size) {}
void pango_font_description_free(PangoFontDescription *desc) { free(desc); }
